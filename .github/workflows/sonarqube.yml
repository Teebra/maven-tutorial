name: SonarQube analysis

on:
  push:
    branches: '*'
  pull_request:
    branches: '*'
  workflow_dispatch:

permissions:
  pull-requests: read # allows SonarQube to decorate PRs with analysis results

jobs:
  Analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 17

      - name: Build with Maven
        run: mvn clean install

      - name: Archive Maven Package
        uses: actions/upload-artifact@v3
        with:
          name: jar_package
          path: target/*.jar

      - name: Analyze with SonarQube
        run: echo sonarqube Analyze
        # Add your SonarQube analysis action here
        # uses: SonarSource/sonarqube-scan-action@7295e71c9583053f5bf40e9d4068a0c974603ec8
        # env:
        #   GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}  # Needed to get PR information
        #   SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        #   SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        # with:
        #   args:
        #     -Dsonar.projectBaseDir=.
        #     -Dsonar.projectVersion=1.${{ github.run_number }}
        #     -Dsonar.java.source=1.8 
        #     -Dsonar.sources=src/main/java
        #     -Dsonar.java.binaries=**classes**
        #     -Dsonar.exclusions=**package-info.**
        #     -Dsonar.sourceEncoding=UTF-8
        #     -Dsonar.projectKey=sonartest
        #     -Dsonar.projectName=sonartest 
        #     -Dsonar.analysis.mode=publish
        #     -Dsonar.dynamicAnalysis=reuseReports

      - name: Get branch name
        id: branch_name
        run: echo "::set-output name=branch_name::${GITHUB_REF#refs/heads/}"

      - name: Check branch name
        run: |
          branch_name=${{ steps.branch_name.outputs.branch_name }}
          if [[ $branch_name == release*0 ]]; then
            echo "fail"
          else
            echo "success"
          fi

  Veracode:
    if: (startsWith(github.ref, 'refs/heads/release') && endsWith(github.ref, '0')) == false

    runs-on: ubuntu-latest
    needs: [Analysis]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Veracode
        run: |
          sleep 20s
          # ls src/bin/script.py

  docker:
    runs-on: ubuntu-latest
    needs: [Analysis, Veracode]
    if: ${{ needs.Veracode.status == 'success' }}

    steps:
      - name: Docker Job
        run: |
          echo docker run

  upload:
    runs-on: ubuntu-latest
    needs: [Analysis, docker, Veracode]
    if: ${{ needs.Veracode.status == 'success' }}

    steps:
      - name: Upload Job1
        if: (startsWith(github.ref, 'refs/heads/release') && endsWith(github.ref, '0')) == false
        run: |
          echo docker run
      
      - name: Upload Job2
        run: |
          echo docker run
      
      - name: Upload Job3
        run: |
          echo docker run
      
      - name: Upload Job4
        run: |
          echo docker run